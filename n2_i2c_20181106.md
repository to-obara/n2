# N2 I2C TTS コマンド仕様

2018-11-06 株式会社KDDI総合研究所


## 前提

- 値はリトルエンディアン(下位バイトから順に送受信)になります。
- デフォルトのアドレスは0x4Eです。

### 表記

   表記   |意味
 :------: | --------------------------------------------
 u8       | 符号なし1バイト値
 u8=x     | 符号なし1バイト値としての値x (固定値)
 i32      | 符号付き4バイト値
 u32      | 符号なし4バイト値
 u8str(x) | 長さxの符号なし1バイト値で構成されるデータ列
 {x}      | 前のデータ形式のx回の繰り返し

## コマンド一覧

コマンド、データ(存在する場合)の順でライトしてください。

  値  |  コマンド名   |データ長| データ           | 備考
:----:| :-----------: | :----: |------------------|-----
 0x00 | READVERSION   |    0   |                  |
 0x01 | READSTATUS    |    0   |                  |
 0x02 | READRESULT    |    0   |                  |
 0x40 | (GETVOLUME)   |    0   |                  |
 0x40 | SETVOLUME     |   0-4  | u32              |
 0x41 |(GETSPEECHRATE)|    0   |                  |
 0x41 | SETSPEECHRATE |   0-4  | u32              |
 0x42 | (GETPITCH)    |    0   |                  |
 0x42 | SETPITCH      |   0-4  | i32              |
 0x61 | RESET         |    0   |                  |
 0x62 | SLEEP         |    0   |                  |
(0x65)| (GETVOICE)    |    0   |                  |
 0x65 | SETVOICE      |   0-4  | u32              | 値は255以下
 0x67 | SETTEXT       |  1-256 | u8, u8str(0-255) | u8はテキストタイプ
 0x68 | START         |    0   |                  |
 0x69 | GETLENGTH     |    0   |                  |
 0x6a | GETPOSITION   |    0   |                  |

- データ長の範囲を超える書き込みに対してNAK応答となります。
- データの最後の値が(u32)の場合はデータ送信をその値の途中で打ち切ることができ
  ます。送信されなかった部分のバイト列はすべて0であるとして処理されます。
- データの最後の値が(i32)の場合もデータ送信をその値の途中で打ち切ることができ
  ます。送信されなかった部分のバイト列は、最後に送信したバイトの値が0x7F以下の
  場合は全て0、0x80以上の場合は全て0xFFであるとして処理されます。


## 値の取得

 先行するコマンド     |データ長| データ| 備考
 -------------------- | :----: | ----- | ------------------
 READVERSION (0x00)   |    4   | u8{4} | {1,5,0,0}
 READSTATUS (0x01)    |    4   | u32   |
 READRESULT (0x02)    |    4   | i32   |
 GETVOLUME (0x40)     |    4   | u32   |
 GETSPEECHRATE (0x41) |    4   | u32   |
 GETPITCH (0x42)      |    4   | i32   |
 GETVOICE (0x65)      |    4   | u32   |
 GETLENGTH (0x69)     |    4   | i32   |
 GETPOSITION (0x70)   |    4   | u32   |

- 4バイトを超えるリードが行われた場合、同じ値が繰り返し出力されます。繰り返し
  の途中で値は更新されますが、各4バイトのリードは常にアトミックです(4バイトの
  読み込みの途中で値が変わることはありません)。
- 予めデバイスにコマンドをライトする必要があります。ライト後のリピートスタート
  による直後のリードを推奨します。
- データをリードする途中でSTOPとしても問題ありません。再度リードすることもでき
  ます。
- コマンドをライトせずに複数回リードを行うことができます。その場合もリピートス
  タートとすることを推奨します。
- 上記のコマンド以外を発行した後にデバイスからリードした場合0xffが返ります。

### 値取得時のI2Cデータシーケンス

以下のようにコマンドをライトした直後にリードを行ってください(リピートスター
ト)。
```
(START) [ADDR(W)] [CMD] (Re-START) [ADDR(R)] [RDATA[0]] [RDATA[1]] ... (STOP)
```

実装上リピートスタートが困難な場合、以下のように、ライト後にSTOP条件でバスを解
放した後、再度START条件からリードを行っても動作します。
```
(START) [ADDR(W)] [CMD] (STOP)
(START) [ADDR(R)] [RDATA[0]] [RDATA[1]] ... (STOP)
```

## コマンド解説
以下、自明なものは除きます。

### READRESULT

その前に発行したGET\*, SET\*, START の終了コードを返します。基本的には対応する
n2tts APIの戻り値が返されます。処理途中で終了コードが確定していない場合は-1が
返されます。

返される値のリストは以下の通りです。

   値   | エラー名称
 :----: | -----------------
 -32766 | N2TTS_ERROR_NOENT
 -32763 | N2TTS_ERROR_IO
 -32761 | N2TTS_ERROR_TOOBIG
 -32756 | N2TTS_ERROR_NOMEM
 -32755 | N2TTS_ERROR_ACCES
 -32746 | N2TTS_ERROR_INVAL
 -32684 | N2TTS_ERROR_ILSEQ
 -32673 | N2TTS_ERROR_NOTSUP
      0 | (no error)

### SETTEXT

音声合成対象のテキストを設定します。音声合成出力を開始するにはSTARTコマンドが
さらに必要です。なお、STARTコマンドの発行前にGETLENGTHを発行できます。

音声合成中にSETTEXTが呼ばれた場合、処理中の音声合成処理は中断します。

データ列の最初の(u8)はテキストタイプで、値が1のときは文字列がプレーンテキス
ト、値が4の時は文字列がJEITA IT-4006 仮名レベル表記であることを表します。

(u8str(x))はUTF-8文字列であり最大255バイトです。0で終端させる必要はありませ
ん。

### GETLENGTH

SETTEXTで設定したテキストを音声合成した場合の長さ(サンプル数)を返します。長さ
を計算中の場合は-1を返します。


## 現実装における制限等

- READSTATUSは常に0を返します。
- RESET、SLEEP、SETVOICE(GETVOICE)は未実装です。


## 利用における注意点等

- デバイス側はクロックストレッチを行います。ただし、クロック周波数が100kHzの場
  合、クロックストレッチ非対応のマスターでも大抵は動作します。動作上の問題が生
  じる場合は クロック周波数を下げてください。
